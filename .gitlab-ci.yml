image: docker:latest

variables:
  REPO: kube-example
  DOCKER_REGISTRY_URL: registry.gitlab.com/ttrahan
  GIT_TAG: $CI_BUILD_TAG
  IMAGE_TAG: $CI_BUILD_REF_NAME.$CI_BUILD_ID
  DOCKER_DRIVER: overlay
  IMGOPTSSAMPLE_VERSION_MEMORY: "128"
  IMGOPTSSAMPLE_VERSION_CPUSHARES: "0.25"

services:
  - docker:dind

before_script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
  - uname -r
  - ls -Rl
  - ./install.sh
  - mkdir ~/.kube
  - aws s3 cp s3://clusters.example-kube-cluster.com/config ~/.kube/config
  - if [[ $CI_BUILD_TAG ]]; then
    IMAGE="$DOCKER_REGISTRY_URL/$REPO:$GIT_TAG"
    else
      IMAGE="$DOCKER_REGISTRY_URL/$REPO:$IMAGE_TAG"
    fi


stages:
  - build
  - deployDev
  - release
  - deployTest

buildImage:
  stage: build
  script:
    - echo "Building $IMAGE"
    - docker build --pull -t $IMAGE .
    - docker push $IMAGE

deployToDev:
  stage: deployDev
  environment: dev
  script:
    - ./deploy.sh

genRelease:
  stage: release
  environment: dev
  script:
    - docker pull $IMAGE
    - docker tag $IMAGE $IMAGE-release
    - docker push $IMAGE-release
  only:
    - tags

deployToTest:
  stage: deployTest
  environment: test
  script:
    - docker version
  when: manual
  only:
    - tags

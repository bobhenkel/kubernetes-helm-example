image: docker:latest

variables:
  REPO: kube-example
  DOCKER_REGISTRY_URL: registry.gitlab.com/ttrahan
  GIT_TAG: $CI_BUILD_TAG
  IMAGE_TAG: $CI_BUILD_REF_NAME.$CI_BUILD_ID
  DOCKER_DRIVER: overlay
  IMGOPTSSAMPLE_VERSION_MEMORY: "128"
  IMGOPTSSAMPLE_VERSION_CPUSHARES: "0.25"

services:
  - docker:dind

before_script:
  - . ./pipeline/install/installGlobal.sh
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
  - if [[ $CI_BUILD_TAG ]]; then
    IMAGE="$DOCKER_REGISTRY_URL/$REPO:$GIT_TAG";
    else
      IMAGE="$DOCKER_REGISTRY_URL/$REPO:$IMAGE_TAG";
    fi

stages:
  - build
  - deployDev
  - release
  - deployTest

buildImage:
  stage: build
  script:
    - echo "Building "$IMAGE
    - docker build --pull -t $IMAGE .
    - docker push $IMAGE

deployToDev:
  stage: deployDev
  environment: dev
  script:
    - echo $TOOL $INSTALL_CMD
    - ./pipeline/install/installAwsCli.sh
    - ./pipeline/install/installKubeCli.sh
    - ./pipeline/deploy.sh

genRelease:
  stage: release
  environment: dev
  script:
    - docker pull $IMAGE
    - docker tag $IMAGE $IMAGE-release
    - docker push $IMAGE-release
  only:
    - tags

deployToTest:
  stage: deployTest
  environment: test
  script:
    - . ./pipeline/install/installAwsCli.sh
    - . ./pipeline/install/installKubeCli.sh
    - . ./pipeline/deploy.sh
  when: manual
  only:
    - tags

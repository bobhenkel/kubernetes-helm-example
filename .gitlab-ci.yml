image: docker:latest

variables:
  REPO: kube-example
  DOCKER_REGISTRY_URL: registry.gitlab.com/ttrahan
  GIT_TAG: $CI_BUILD_TAG
  IMAGE_TAG: $CI_BUILD_REF_NAME.$CI_BUILD_ID
  DOCKER_DRIVER: overlay
  IMGOPTSSAMPLE_VERSION_MEMORY: "128"
  IMGOPTSSAMPLE_VERSION_CPUSHARES: "0.25"
  DISTRO: alpine
  STATE_STORE: s3://gitlab-state-store

services:
  - docker:dind

before_script:
  - . ./pipeline/install/installGlobal.sh # execute in same shell
  - . ./pipeline/install/installAwsCli.sh
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
  - if [[ $CI_BUILD_TAG ]]; then
    export IMAGE="$DOCKER_REGISTRY_URL/$REPO:$GIT_TAG" &&
    export TAG="$GIT_TAG";
    else
      export IMAGE="$DOCKER_REGISTRY_URL/$REPO:$IMAGE_TAG" &&
      export TAG="$IMAGE_TAG";
    fi

stages:
  - build
  - deployDev
  - release
  - deployTest

buildImage:
  stage: build
  script:
    - echo "Building "$IMAGE
    - docker build --pull -t $IMAGE .
    - docker push $IMAGE
    - echo export LAST_IMAGE_BUILT=$TAG > state_last_image.env
    - aws s3 cp state_last_image.env $STATE_STORE

deployToDev:
  stage: deployDev
  environment: dev
  script:
    - ./pipeline/install/installKubeCli.sh
    - aws s3 cp $STATE_STORE/state_last_image.env . && source state_last_image.env && TAG=$LAST_IMAGE_BUILT
    - ./pipeline/deploy.sh
    - echo export LAST_IMAGE_DEPLOYED_DEV=$TAG > state_last_deployToDev.env

genRelease:
  stage: release
  environment: dev
  script:
    - aws s3 cp $STATE_STORE/state_last_deployToDev.env . && source state_last_deployToDev.env && TAG=$LAST_IMAGE_DEPLOYED_DEV
    - echo export LATEST_RELEASE=$TAG > state_latest_release.env
  only:
    - tags

deployToTest:
  stage: deployTest
  environment: test
  script:
    - ./pipeline/install/installKubeCli.sh
    - aws s3 cp $STATE_STORE/state_latest_release.env . && source state_latest_release.env && TAG=$LATEST_RELEASE
    - ./pipeline/deploy.sh
  when: manual
  only:
    - tags
